## https://www.malware-traffic-analysis.net/2019/09/25/index2.html  
pass: infected

### MTA Notes:  
- Today's Trickbot infection spread from the infected Windows client to the Domain Controller (DC), and I think it was caused by Trickbot's mwormDll64 module.  
- As early as 2019-09-16, Trickbot modules mshareDll64 and mwormDll64 replaced the old shareDll64 and wormDll64 modules.  
- Since then, this is the first time I've run a Trickbot infection within an Active Directory (AD) environment.  
- With the old modules, an infected client would download a Trickbot EXE from a .png URL and send that over SMB to a vulnerable DC.  
- In today's example with the new mshareDll64 and mwormDll64 modules, the vulnerable DC downloaded Trickbot from a .png URL.  
- No Trickbot EXE was sent from the infected client to the DC, like I'd seen before.  

### Jason Notes:   
- Although I immediately noticed 113 intel hits, we'll assume for a minute that we don't have that secondary system set up (intelstack).  

`index=zeek sourcetype="bro:notice:json"` shows a fair amount of self signed certs as well as some hits from detect-MHR.bro's Malware Hash Registry detection function. We can narrow down into that to find the initial hosts of interest;  
```
index=zeek sourcetype="bro:notice:json" body="Malware Hash Registry Detection*" 
| table id.orig_h 
| dedup id.orig_h
```
`index=zeek sourcetype="bro:known_services:json"` shows that 10.9.25.9 is likely the DC based on the services offered. 10.9.25.102 is another host that is possibly a workstation with atleast MSIE and Chrome installed and seemingly casual browsing habits.   

A casual view of the DNS queries from both hosts indicate suspicious activity (queries to odd TLDs and onion TLD)   
```
index=zeek 10.9.25.9 sourcetype="bro:dns:json" 
|  stats values(query) by id.orig_h
```

Analyzing the files quickly reveals suspicious behavior with a download of `knpow56_38.exe`. Nothing afterwards has a filename, it is likely that other files are disguised since there are 5 total EXEs.   
```
index=zeek sourcetype="bro:files:json" | sort _time
```
Only binaries;  
```
index=zeek sourcetype="bro:files:json" mime_type="application/x-dosexec" | sort _time
```

Using subsearch we can see that all of those UIDs relate to HTTP events, instead of the expected SMB (as mentioned in the MTA notes).  
```
index=zeek [ search index=zeek sourcetype="bro:files:json" mime_type="application/x-dosexec" 
    | rename conn_uids as uid 
    | table uid] 
|  stats count by sourcetype
```
As expected, the notice logs revealed the Malware Hash Registry events. More interesting are the uri's that trickbot is downloaded through;  
```
index=zeek 
    [ search index=zeek sourcetype="bro:files:json" mime_type="application/x-dosexec" 
    | rename conn_uids as uid 
    | table uid] sourcetype="bro:http:json"
```
In order, these are the GETs with `wredneg2.png` happening at nearly the exact same time on the two different hosts. Despite this order, the DC occurs first, meaning that whatever module infected it occurs prior to this.
1. 10.9.25.102	/wp-includes/gvju6u-lse19-698411/	knpow56_38.exe
2. 10.9.25.102	/samerton.png	 
3. 10.9.25.102	/wredneg2.png	 
4. 10.9.25.9	/wredneg2.png	 
5. 10.9.25.9	/samerton.png

Of interest is the breakpoint where both hosts do the same GET  
**C5XteI3c9gryBhyiia 10.9.25.102**  
**CSRlIX3RzvdG1Jv2T5 10.9.25.9**  

Previous to these events we see 10.9.25.102 smb mapping `index=zeek sourcetype="bro:smb_mapping:json"` and some LDAP traffic. We'd need install the LDAP analyzer to have more detail into the LDAP traffic without going to PCAP directly. This is likely mwormDll64 being used to infect 10.9.25.9 from 10.9.25.102.
