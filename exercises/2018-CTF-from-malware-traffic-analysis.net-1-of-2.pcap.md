# https://www.malware-traffic-analysis.net/2018/CTF/index.html  
pass:infected  
Where you see `->` that implies a new search based on the previous results.  

remoLAN SEGMENT PROPERTIES:

LAN segment: 192.168.2.0/24 (192.168.2.0 through 192.168.2.255)
Domain: dnipromotors.com  
Domain controller: 192.168.2.4 - Dnipromotors-DC  
LAN segment gateway: 192.168.2.1  
LAN segment broadcast address: 192.168.2.255  
Windows client to investigate: 192.168.2.147  

TASKS I SUGGESTED:
---
What is the MAC address of the Windows client at 192.168.2.147? bc:5f:f4:a6:d1:29 

```
index=zeek sourcetype="bro:dhcp:json" 192.168.2.147 | table mac
```

---
What is the host name for the Windows client at 192.168.2.147? Lyakh-Win7-PC 

```
index=zeek sourcetype="bro:dhcp:json" 192.168.2.147 | table host_name
```

---
Based on the Kerberos traffic, what is the Windows user account name used on 192.168.2.147?   
jermija.lyakh/DNIPROMOTORS.COM 

```
index=zeek sourcetype="bro:kerberos:json" 192.168.2.147 | table client
```

---
What is the URL that returned a Windows executable file?    
micropcsystem.com:80/hojuks/vez.exe 
```
index=zeek | stats count by mime_type -> index=zeek mime_type="application/x-dosexec" -> index=zeek CCKoQm4x0DBlmC7q8i sourcetype="bro:http:json" | table url
```

---
When did the URL happen? (date and time in UTC)   
```
time in log, but out of sync due to replay method.
```

---
How many bytes is the Windows executable file returned from that URL?   
699392 
```
index=zeek CCKoQm4x0DBlmC7q8i sourcetype="bro:http:json" | table response_body_len
``` 
or for more accuracy 
```
index=zeek mime_type="application/x-dosexec" | table total_bytes
``` 
or for using with subsearch 
```
index=zeek sourcetype="bro:files:json" [ search index=zeek sourcetype="bro:http:json" url="micropcsystem.com:80/hojuks/vez.exe" | table resp_fuids | rename resp_fuids as fuid] | table total_bytes
```

---
What is the SHA256 file hash of the Windows executable file returned from that URL?   
sha1 is acb43ca4a645b1c75513ec3f877836801f743ff1  
sha256 requires an edit to /opt/bro/share/bro/policy/frameworks/files/hash-all-files.bro and a restart of bro.
```
index=zeek sourcetype="bro:files:json" [ search index=zeek sourcetype="bro:http:json" url="micropcsystem.com:80/hojuks/vez.exe" | table resp_fuids | rename resp_fuids as fuid] | table sha256
```

---
After receiving the Windows executable file, what IP address did the infected Windows host try to establish a TCP connection with? 93.87.38.24
```
index=zeek sourcetype="bro:conn:json" "id.orig_h"="192.168.2.147" proto=tcp
``` 
-> visually identify the events immediate after 198.54.126.123
OR WITH SUBSEARCH
```
"id.orig_h"="192.168.2.147" id.resp_h=* proto=tcp sourcetype=*conn* 
    [ search "id.orig_h"="192.168.2.147" "id.resp_h"="198.54.126.123" proto=tcp 
    | head 1
    | eval timestamp_epoch = strptime(ts, "%Y-%m-%dT%H:%M:%S.%6N") 
    | eval earliest=timestamp_epoch 
    | table earliest 
    | format] 
| tail 1
```
