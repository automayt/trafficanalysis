## https://www.malware-traffic-analysis.net/2018/CTF/2018-CTF-from-malware-traffic-analysis.net-2-of-2.pcap.zip
pass: infected

LAN SEGMENT PROPERTIES:  

LAN segment: 172.17.1.0/24 (172.17.1.0 through 172.17.1.255)  
Domain: kyivartworks.com  
Domain controller: 172.17.1.2 - Kyivartworks-DC  
LAN segment gateway: 172.17.1.1  
LAN segment broadcast address: 172.17.1.255  
Windows client to investigate: 172.17.1.129  
TASKS I SUGGESTED:  
___
**we'll wrap both of these into the same query**  
What is the MAC address of the Windows client at 172.17.1.129?  
What is the host name for the Windows client at 172.17.1.129?  
**00:1e:67:4a:d7:5c	Nalyvaiko-PC**
```
index=zeek sourcetype="bro:dhcp:json" client_addr="172.17.1.129" 
|  table mac host_name
```
___
Based on the Kerberos traffic, what is the Windows user account name used on 172.17.1.129?  
**innochka.nalyvaiko**
```
index=zeek sourcetype="bro:kerberos:json" "id.orig_h"="172.17.1.129" 
| dedup client | table client
```
___
What URL in the pcap returned a Microsoft Word document?
**ifcingenieria.cl:80/QpX8It/BIZ/Firmenkunden/**

The slower way, but more analysis focused way would be;  
`index=zeek | stats count by mime_type` -> discover the mime_type "application/msword" and pivot to it.  
vvv  
`index=zeek uid=CBlTHWIhc8txaE0M5 sourcetype="bro:http:json" | table url` -> the uid came from the "conn_uids" field in files.log.  

The more streamlined (though maybe prone to error) way would be to use a subsearch. If the mime_type isn't correct, it could miss it;  
```
index=zeek sourcetype="bro:http:json"
    [ search index=zeek mime_type="application/msword" 
    | rename conn_uids as uid 
    | table uid] 
| table url
```
___
When did the URL happen? (date and time in UTC)  
**Time is only accurate when not replaying through interface**
___
How many bytes is the Word document returned from that URL?  
**73088**  
```
index=zeek mime_type="application/msword" 
| table seen_bytes filename sha256
```
___
What is the SHA256 of the Word document returned from that URL?  
**09ebe4229a74cdb1212671e6391742cc6bee387bf14da02974b07857b27f9223**
sha256 requires an edit to /opt/bro/share/bro/policy/frameworks/files/hash-all-files.bro and a restart of bro. It would look like this;  
```
##! Perform MD5 and SHA1 hashing on all files.

@load base/files/hash

event file_new(f: fa_file)
        {
        Files::add_analyzer(f, Files::ANALYZER_MD5);
        Files::add_analyzer(f, Files::ANALYZER_SHA1);
        Files::add_analyzer(f, Files::ANALYZER_SHA256);                                                                          
        }
```
What URL in the pcap returned a Windows executable file?  
**timlinger.com:80/nmw/**
```
index=zeek sourcetype="bro:http:json"
    [ search index=zeek mime_type="application/x-dosexec"
    | rename conn_uids as uid 
    | table uid] 
| table url
```
___
How many bytes is the Windows executable file returned from that URL?
**429056	6169583.exe**
```
index=zeek mime_type="application/x-dosexec" |  table seen_bytes filename
```
___
What is the SHA256 of the Windows executable file returned from that URL?  
**69e731afb5f27668b3a77e19a15e62cce84e623404077a8563fcf61450d8b741**
See notes from the previous sha256 question for details.  
```
index=zeek mime_type="application/x-dosexec" |  table seen_bytes filename sha256
```
___
What type of infection occurred in this pcap?  
Emotet
https://www.virustotal.com/gui/file/69e731afb5f27668b3a77e19a15e62cce84e623404077a8563fcf61450d8b741/detection
https://www.virustotal.com/gui/file/09ebe4229a74cdb1212671e6391742cc6bee387bf14da02974b07857b27f9223/detection

In addition to HTTP post-infection traffic, what other type of post-infection traffic is generated by the infected Windows host?  
Investigate sourcetypes that occurred after the initial URL;  
```
index=zeek 
    [ search url="ifcingenieria.cl:80/QpX8It/BIZ/Firmenkunden/"
    | head 1
    | eval timestamp_epoch = strptime(ts, "%Y-%m-%dT%H:%M:%S.%6N") 
    | eval earliest=timestamp_epoch 
    | table earliest 
    | format] 
|  stats count by sourcetype
```
Investigating the SMTP logs reveals encrypted smtp communications, and dns logs show 3506 different destination dns queries for mail.somedomain.sometld
```
index=zeek 
    [ search url="ifcingenieria.cl:80/QpX8It/BIZ/Firmenkunden/" 
    | head 1 
    | eval timestamp_epoch = strptime(ts, "%Y-%m-%dT%H:%M:%S.%6N") 
    | eval earliest=timestamp_epoch 
    | table earliest id.orig_h 
    | format ] sourcetype="bro:dns:json" 
| dedup query 
| table query
```
example;  
```
SMTP.GOOGLE.COM
SMTP.LWISD.ORG
MAIL.JCSB.ORG
SMTP.IBVPN.COM
SMTP.AMAZON.CN
SMTP.DOC88.COM
MAIL.GMAIL.COM
SMTP.CANVA.COM
SMTP.MAZ.ES
SMTP.LOWES.COM
MAIL.VERY.CO.UK
smtp.liga-stavokbk.com
mymail4.myregisteredsite.com
mail.blountboe.net
smtp.d2c.firstygroup.com
smtp.dispenza.customerhub.net
smtp.maz.es
```
